<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Librarian Pro - v1.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --header: #1e293b;
            --text: #f8fafc; --primary: #60a5fa; --border: #334155;
            --modal-bg: rgba(15, 23, 42, 0.98); 
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { background: var(--header); padding: 15px; color: white; border-bottom: 1px solid var(--border); text-align: center; flex-shrink: 0; }
        .controls { display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 10px; flex-wrap: wrap; }
        
        #library { flex: 1; display: grid; gap: 12px; padding: 20px; align-content: start; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); overflow-y: auto; }
        
        .pdf-card { background: var(--card); border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; overflow: hidden; height: fit-content; }
        .pdf-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .pdf-card.hidden { display: none; }
        .cover-img { width: 100%; aspect-ratio: 3/4; object-fit: cover; display: block; }
        .card-info { padding: 6px; font-size: 9px; text-align: center; line-height: 1.3; }

        #modal { display: none; position: fixed; inset: 0; background: var(--modal-bg); z-index: 1000; padding: 10px; }
        .modal-container { display: grid; grid-template-columns: 300px 1fr; width: 100%; height: 100%; background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }

        .sidebar { background: var(--header); border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-tools { padding: 10px; border-bottom: 1px solid var(--border); position: relative; }
        #pdfSearch { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border); font-size: 13px; background: #0f172a; color: white; box-sizing: border-box; }
        
        .viewer { background: #334155; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; align-items: center; scroll-behavior: smooth; height: 100%; padding: 20px 0; }
        .page-wrapper { position: relative; margin-bottom: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
        canvas { display: block; width: 100% !important; height: auto !important; }

        .close-modal { position: absolute; top: 15px; right: 25px; font-size: 30px; color: white; cursor: pointer; z-index: 1001; }
        input, select { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px; background: #0f172a; color: white; }
        .btn-action { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; background: var(--primary); color: white; }
        
        #bookmark-status { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 8px 20px; border-radius: 20px; font-size: 12px; display: none; z-index: 2000; }
    </style>
</head>
<body>

<div id="bookmark-status">Resumed from last visit!</div>

<header>
    <div style="font-size: 20px; font-weight: 800;">ðŸ“š PDF Librarian Pro</div>
    <div class="controls">
        <label class="btn-action" for="folderInput">ðŸ“‚ Open Folder</label>
        <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none;">
        <input type="text" id="searchInput" placeholder="Search library..." oninput="applyFilters()">
        
        <select id="sortSelect" onchange="handleSort()">
            <option value="none">Sort By...</option>
            <option value="name">Filename (A-Z)</option>
            <option value="size">File Size</option>
            <option value="pages">Page Numbers</option>
        </select>

        <select id="sizeFilter" onchange="applyFilters()">
            <option value="all">Any Size</option>
            <option value="small">Small (< 5MB)</option>
            <option value="large">Large (> 20MB)</option>
        </select>
        <select id="pageFilter" onchange="applyFilters()">
            <option value="all">Any Pages</option>
            <option value="short">Short (< 50p)</option>
            <option value="long">Long (> 200p)</option>
        </select>
    </div>
</header>

<div id="library"></div>

<div id="modal">
    <div class="close-modal" onclick="closeModal()">âœ•</div>
    <div class="modal-container">
        <div class="sidebar">
            <div class="sidebar-tools">
                <input type="text" id="pdfSearch" placeholder="ðŸ” Find in book..." onkeyup="handleSearch(this.value)">
                <div id="searchResults" class="search-results" style="display:none;"></div>
            </div>
            <div id="toc-box" class="toc-list"></div>
        </div>
        <div class="viewer" id="viewer-main" onscroll="trackScroll()">
            <div id="pdf-stack" style="width:90%; display:flex; flex-direction:column; align-items:center;"></div>
        </div>
    </div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let filesData = [];
    let currentPdf = null;
    let currentFileName = "";

    document.getElementById('folderInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
        document.getElementById('library').innerHTML = '';
        filesData = [];
        for (const file of files) {
            try {
                const arr = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arr }).promise;
                const page = await pdf.getPage(1);
                const canvas = document.createElement('canvas');
                const vp = page.getViewport({ scale: 0.2 });
                canvas.width = vp.width; canvas.height = vp.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
                const item = { 
                    name: file.name, doc: pdf, pages: pdf.numPages, 
                    sizeMB: file.size / (1024 * 1024), cover: canvas.toDataURL(), 
                    outline: await pdf.getOutline() 
                };
                filesData.push(item);
            } catch (err) { console.error(err); }
        }
        renderLibrary();
    });

    function renderLibrary() {
        const container = document.getElementById('library');
        container.innerHTML = '';
        filesData.forEach(item => {
            const card = document.createElement('div');
            card.className = 'pdf-card';
            card.onclick = () => openDoc(item);
            card.innerHTML = `<img src="${item.cover}" class="cover-img"><div class="card-info"><b>${item.name.substring(0,15)}...</b><br>${item.pages}p | ${item.sizeMB.toFixed(1)} MB</div>`;
            container.appendChild(card);
        });
        applyFilters();
    }

    function handleSort() {
        const val = document.getElementById('sortSelect').value;
        if (val === 'name') filesData.sort((a, b) => a.name.localeCompare(b.name));
        if (val === 'size') filesData.sort((a, b) => b.sizeMB - a.sizeMB);
        if (val === 'pages') filesData.sort((a, b) => b.pages - a.pages);
        renderLibrary();
    }

    async function openDoc(item) {
        currentPdf = item.doc; currentFileName = item.name;
        document.getElementById('modal').style.display = 'block';
        const stack = document.getElementById('pdf-stack');
        stack.innerHTML = '';
        const box = document.getElementById('toc-box');
        box.innerHTML = '<strong>Contents</strong><br><br>';
        if (item.outline) buildToC(item.outline, box);

        const vWidth = document.getElementById('viewer-main').clientWidth * 0.95;
        const firstPage = await currentPdf.getPage(1);
        const autoScale = vWidth / firstPage.getViewport({scale: 1.0}).width;

        for (let n = 1; n <= item.pages; n++) {
            const page = await currentPdf.getPage(n);
            const vp = page.getViewport({ scale: autoScale });
            const wrap = document.createElement('div');
            wrap.id = `wrap-${n}`; wrap.className = 'page-wrapper';
            wrap.style.width = vp.width + 'px'; wrap.style.height = vp.height + 'px';
            const canvas = document.createElement('canvas');
            canvas.width = vp.width; canvas.height = vp.height;
            wrap.appendChild(canvas);
            stack.appendChild(wrap);
            page.render({ canvasContext: canvas.getContext('2d'), viewport: vp });
        }

        const saved = localStorage.getItem('bookmark-' + currentFileName);
        if (saved) { setTimeout(() => { navigateToPage(parseInt(saved)); showToast(); }, 600); }
    }

    function trackScroll() {
        if (!currentFileName) return;
        const viewer = document.getElementById('viewer-main');
        const wrappers = document.querySelectorAll('.page-wrapper');
        let currentP = 1;
        wrappers.forEach((el, idx) => { if (el.offsetTop <= (viewer.scrollTop + 100)) currentP = idx + 1; });
        localStorage.setItem('bookmark-' + currentFileName, currentP);
    }

    function navigateToPage(p) {
        const el = document.getElementById(`wrap-${p}`);
        if(el) document.getElementById('viewer-main').scrollTo({ top: el.offsetTop - 10, behavior: 'smooth' });
    }

    function applyFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const sF = document.getElementById('sizeFilter').value;
        const pF = document.getElementById('pageFilter').value;
        const cards = document.querySelectorAll('.pdf-card');
        
        filesData.forEach((item, index) => {
            const card = cards[index];
            if (!card) return;
            let show = item.name.toLowerCase().includes(q);
            if (sF==='small' && item.sizeMB>=5) show=false;
            if (sF==='large' && item.sizeMB<20) show=false;
            if (pF==='short' && item.pages>=50) show=false;
            if (pF==='long' && item.pages<200) show=false;
            card.classList.toggle('hidden', !show);
        });
    }

    async function buildToC(items, container) {
        items.forEach(async item => {
            const d = document.createElement('div'); d.className = 'toc-row'; d.innerText = item.title;
            d.onclick = async () => {
                const dest = typeof item.dest === 'string' ? await currentPdf.getDestination(item.dest) : item.dest;
                if (dest) navigateToPage((await currentPdf.getPageIndex(dest[0])) + 1);
            };
            container.appendChild(d);
            if (item.items && item.items.length > 0) {
                const sub = document.createElement('div'); sub.style.paddingLeft = "10px";
                buildToC(item.items, sub); container.appendChild(sub);
            }
        });
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; currentFileName = ""; }
</script>
</body>
</html>
