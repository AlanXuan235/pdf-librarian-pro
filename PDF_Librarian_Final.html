<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Librarian Pro - Dark Mode Default</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --header: #0f172a;
            --text: #1e293b; --primary: #3b82f6; --border: #e2e8f0;
            --modal-bg: rgba(15, 23, 42, 0.96); 
        }
        /* Dark Mode variables are active by default now */
        body.dark-mode {
            --bg: #0f172a; --card: #1e293b; --header: #1e293b;
            --text: #f8fafc; --primary: #60a5fa; --border: #334155;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        
        header { background: var(--header); padding: 15px; color: white; position: sticky; top: 0; z-index: 100; text-align: center; }
        .controls { display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 10px; flex-wrap: wrap; }
        
        #library { display: grid; gap: 12px; padding: 20px; align-content: start; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
        
        .pdf-card { background: var(--card); border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; overflow: hidden; height: fit-content; }
        .pdf-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .pdf-card.hidden { display: none; }
        .cover-img { width: 100%; aspect-ratio: 3/4; object-fit: cover; display: block; }
        .card-info { padding: 6px; font-size: 9px; text-align: center; line-height: 1.3; }

        #modal { display: none; position: fixed; inset: 0; background: var(--modal-bg); z-index: 1000; padding: 15px; }
        .modal-container { display: grid; grid-template-columns: 380px 1fr; width: 100%; height: 92vh; background: var(--card); border-radius: 12px; overflow: hidden; }

        .sidebar { background: var(--bg); border-right: 2px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
        
        .sidebar-tools { padding: 10px; border-bottom: 1px solid var(--border); background: var(--card); position: relative; }
        .search-wrapper { position: relative; display: flex; align-items: center; }
        #pdfSearch { width: 100%; padding: 8px 30px 8px 10px; border-radius: 6px; border: 1px solid var(--border); font-size: 13px; background: #fff; color: #000; }
        
        .clear-search { 
            position: absolute; right: 10px; cursor: pointer; color: #94a3b8; font-weight: bold; font-size: 16px; 
            display: none; user-select: none;
        }
        .clear-search:hover { color: #ef4444; }

        .search-results { 
            padding: 5px 0; max-height: 250px; overflow-y: auto; 
            background: #1e293b; border-bottom: 2px solid var(--primary);
        }
        .res-item { 
            padding: 10px 15px; cursor: pointer; color: #60a5fa !important; 
            font-weight: bold; border-bottom: 1px solid #334155; font-size: 12px;
        }
        .res-item:hover { background: #334155; color: #ffffff !important; }

        .toc-list { flex: 1; overflow-y: auto; padding: 10px; }
        .toc-row { display: flex; align-items: center; padding: 6px; cursor: pointer; font-size: 11px; }
        .toc-toggle { width: 20px; font-weight: bold; color: var(--primary); cursor: pointer; }
        .toc-sub { padding-left: 15px; display: none; border-left: 1px solid var(--border); }
        .toc-sub.open { display: block; }

        .viewer { background: #525659; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; scroll-behavior: smooth; }
        .page-wrapper { position: relative; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        canvas { background: white; display: block; max-width: 100%; height: auto !important; }

        .search-highlight { position: absolute; background: rgba(255, 255, 0, 0.4); border: 2px solid red; pointer-events: none; z-index: 10; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { opacity: 0.4; } to { opacity: 0.8; } }

        .close-modal { position: absolute; top: 0; right: 20px; font-size: 45px; color: white; cursor: pointer; }
        input, select { padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px; }
        .btn-action { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
    </style>
</head>
<body class="dark-mode">

<header>
    <div style="font-size: 22px; font-weight: 800;">üìö PDF Librarian Pro</div>
    <div class="controls">
        <label class="btn-action" style="background: #3b82f6; color: white;" for="folderInput">üìÇ Open Folder</label>
        <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none;">
        <input type="text" id="searchInput" placeholder="Search library..." oninput="applyFilters()">
        <select id="sizeFilter" onchange="applyFilters()">
            <option value="all">Any Size</option>
            <option value="small">Small (< 1MB)</option>
            <option value="large">Large (> 5MB)</option>
        </select>
        <select id="pageFilter" onchange="applyFilters()">
            <option value="all">Any Pages</option>
            <option value="short">Short (< 50p)</option>
            <option value="long">Long (> 100p)</option>
        </select>
        <button class="btn-action" id="themeToggle" style="background: #fff; border: 1px solid #ddd;" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>
</header>

<div id="library"></div>

<div id="modal">
    <div class="close-modal" onclick="closeModal()">&times;</div>
    <div class="modal-container">
        <div class="sidebar">
            <div class="sidebar-tools">
                <div class="search-wrapper">
                    <input type="text" id="pdfSearch" placeholder="üîç Find word..." onkeyup="handleSearch(this.value)">
                    <span id="clearBtn" class="clear-search" onclick="clearInternalSearch()">&times;</span>
                </div>
                <div id="searchResults" class="search-results" style="display:none;"></div>
            </div>
            <div id="toc-box" class="toc-list"></div>
        </div>
        <div class="viewer" id="viewer-main">
            <div id="pdf-stack" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        </div>
    </div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let filesData = [];
    let currentPdf = null;

    // Theme Toggle Logic
    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        document.getElementById('themeToggle').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    document.getElementById('folderInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
        document.getElementById('library').innerHTML = '';
        filesData = [];
        for (const file of files) {
            try {
                const arr = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arr }).promise;
                const page = await pdf.getPage(1);
                const canvas = document.createElement('canvas');
                const vp = page.getViewport({ scale: 0.3 });
                canvas.width = vp.width; canvas.height = vp.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
                const item = { id: 'pdf-'+Math.random().toString(36).substr(2,9), name: file.name, doc: pdf, pages: pdf.numPages, sizeKB: Math.round(file.size/1024), cover: canvas.toDataURL(), outline: await pdf.getOutline() };
                filesData.push(item);
                renderThumb(item);
            } catch (err) {}
        }
    });

    function renderThumb(item) {
        const card = document.createElement('div');
        card.className = 'pdf-card'; card.id = item.id;
        card.onclick = () => openDoc(item);
        card.innerHTML = `<img src="${item.cover}" class="cover-img"><div class="card-info"><b>${item.name.substring(0,12)}...</b><br>${item.pages}p | ${item.sizeKB} KB</div>`;
        document.getElementById('library').appendChild(card);
    }

    async function openDoc(item) {
        currentPdf = item.doc;
        document.getElementById('modal').style.display = 'block';
        document.getElementById('pdf-stack').innerHTML = '';
        const box = document.getElementById('toc-box');
        box.innerHTML = '<h4>Contents</h4>';
        if (item.outline) buildToC(item.outline, box);

        for (let n = 1; n <= item.pages; n++) {
            const page = await currentPdf.getPage(n);
            const vp = page.getViewport({ scale: 1.5 });
            const wrap = document.createElement('div');
            wrap.id = `wrap-${n}`; wrap.className = 'page-wrapper';
            wrap.style.width = vp.width+'px'; wrap.style.height = vp.height+'px';
            const canvas = document.createElement('canvas');
            canvas.height = vp.height; canvas.width = vp.width;
            wrap.appendChild(canvas);
            document.getElementById('pdf-stack').appendChild(wrap);
            page.render({ canvasContext: canvas.getContext('2d'), viewport: vp });
        }
    }

    async function buildToC(items, container) {
        const list = document.createElement('div');
        for (const item of items) {
            const entry = document.createElement('div');
            const hasSubs = item.items && item.items.length > 0;
            const row = document.createElement('div');
            row.className = 'toc-row';
            row.innerHTML = `<span class="toc-toggle">${hasSubs ? '‚ñ∂' : ''}</span><span style="flex:1">${item.title}</span>`;
            
            let pIdx = 0;
            try {
                const dest = typeof item.dest === 'string' ? await currentPdf.getDestination(item.dest) : item.dest;
                if (dest) pIdx = (await currentPdf.getPageIndex(dest[0])) + 1;
            } catch(e) {}

            row.onclick = () => navigateToPage(pIdx);
            const sub = document.createElement('div');
            sub.className = 'toc-sub';
            if (hasSubs) {
                row.querySelector('.toc-toggle').onclick = (e) => { e.stopPropagation(); sub.classList.toggle('open'); e.target.innerText = sub.classList.contains('open') ? '‚ñº' : '‚ñ∂'; };
                buildToC(item.items, sub);
            }
            entry.append(row, sub);
            list.appendChild(entry);
        }
        container.appendChild(list);
    }

    function handleSearch(val) {
        document.getElementById('clearBtn').style.display = val ? 'block' : 'none';
        searchInside(val);
    }

    function clearInternalSearch() {
        const input = document.getElementById('pdfSearch');
        input.value = '';
        document.getElementById('clearBtn').style.display = 'none';
        document.getElementById('searchResults').style.display = 'none';
        document.querySelectorAll('.search-highlight').forEach(h => h.remove());
    }

    async function searchInside(query) {
        const resDiv = document.getElementById('searchResults');
        if (!query || query.length < 3) { resDiv.style.display = 'none'; return; }
        resDiv.innerHTML = '<div style="color:white; padding:10px;">Searching...</div>';
        resDiv.style.display = 'block';
        let matches = [];
        for (let i = 1; i <= currentPdf.numPages; i++) {
            const page = await currentPdf.getPage(i);
            const content = await page.getTextContent();
            if (content.items.map(s => s.str).join(' ').toLowerCase().includes(query.toLowerCase())) {
                matches.push(i);
                if (matches.length > 15) break;
            }
        }
        resDiv.innerHTML = matches.length ? '' : '<div style="color:red; padding:10px;">Not found</div>';
        matches.forEach(p => {
            const d = document.createElement('div'); d.className = 'res-item'; d.innerText = `Page ${p}`;
            d.onclick = () => { navigateToPage(p); highlightWord(p, query); };
            resDiv.appendChild(d);
        });
    }

    function navigateToPage(p) {
        const v = document.getElementById('viewer-main');
        const el = document.getElementById(`wrap-${p}`);
        if(el) v.scrollTo({ top: el.offsetTop - 20, behavior: 'smooth' });
    }

    async function highlightWord(p, word) {
        const wrap = document.getElementById(`wrap-${p}`);
        wrap.querySelectorAll('.search-highlight').forEach(h => h.remove());
        const page = await currentPdf.getPage(p);
        const vp = page.getViewport({ scale: 1.5 });
        const content = await page.getTextContent();
        content.items.forEach(item => {
            if (item.str.toLowerCase().includes(word.toLowerCase())) {
                const tx = pdfjsLib.Util.transform(vp.transform, item.transform);
                const h = document.createElement('div'); h.className = 'search-highlight';
                h.style.cssText = `left:${tx[4]}px; top:${tx[5] - (item.height*1.5)}px; width:${item.width*1.5}px; height:${item.height*1.5}px;`;
                wrap.appendChild(h);
            }
        });
    }

    function applyFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const sF = document.getElementById('sizeFilter').value;
        const pF = document.getElementById('pageFilter').value;
        filesData.forEach(item => {
            const card = document.getElementById(item.id);
            let show = item.name.toLowerCase().includes(q);
            if (sF==='small' && item.sizeKB>=1000) show=false;
            if (sF==='large' && item.sizeKB<5000) show=false;
            if (pF==='short' && item.pages>=50) show=false;
            if (pF==='long' && item.pages<100) show=false;
            card.classList.toggle('hidden', !show);
        });
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; clearInternalSearch(); }
</script>
</body>
</html>